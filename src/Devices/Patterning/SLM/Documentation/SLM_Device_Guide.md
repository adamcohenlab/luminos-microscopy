# SLM Device Controller Guide

This is an under-development polymorhpic controller for SLM devices that includes the key features and data structures required for calibrating an SLM and generating registered patterns. In order to use the controller, you'll need to generate an SLM_Device object by calling using the SLM_obj=SLM_Device(basepath) contructor (here the SLM_obj name can be replaced by whatever you want to name your SLM device and basepath indicates the path to the rig-specific configuration files). The contructor will read in the parameters from the rig-specific configuration text files and

## Properties
The following are properties of all SLM_Device objects and can be read or modified using the obj.property syntax. Most are initialized to default values using textfiles when the constructor is called.

###### Device_Model
String that indicates the model of the SLM device. Could be used to define "compatibility" groups in future versions or as a sanity check to make sure you've loaded the correct device parameters.

###### Dimensions
Dimensions of the SLM device in pixels.

###### LUT_Filepath
Path to LUT file for SLM. Will likely be removed as a property in future version.

###### Blaze
Sets the default blazed grating pitch in x and y for the SLM. This is useful if you use a blaze duing alignment of the SLM and want all of your holograms laid on top of the blaze by default. Will be loaded from parameter file when the device constructor is called. Can also be modified by the program.

###### WavefrontCorrection
Not currently included. Should provide the path to a parameter file for default wavefront correction.

###### Focus
Optional Term to add quadratic phase to the SLM to move the focus.

###### Hologram_Stack
Buffer of generated holograms stored as a structure. Future versions will likely integrate some handshaking between this and any onboard frame buffer in the SLM itself. For now, it is just a convenient structure for storing and cycling between pre-computed holograms.

###### Stack_Frame_Num
Index of currently displayed hologram from the stack.

###### Spot_Width
Size of the laser spot (in SLM pixels) on the SLM face. Note: not to be confused with the PSF of the SLM in the objective's image plane.

###### Target
Pattern that you would like to generate in the sample plane. This array is used as an input to generate holograms. Multiple methods are available to generate targets from selected ROIs.

###### tform_file
Filepath to the stored 3x3 affine transform that converts points selected in camera coordinates to an equivalent ROI in SLM target array coordinates.

###### calpoints_file
Filepath to the stored list of points used to calibrate the SLM. These points are all on the open interval (0,1).

###### tform
Affine transform that converts ROIs selected in camera coordinates to equivalent ROIs in SLM target coordinates.

###### calpoints
Stored list of points used to calibrate the SLM. After loading the fractional points from the calpoints_file, the program mutiplies the spot coordinates by the dimensions of the SLM and rounds them up to convert the relative coordinates stored in the file to equivalent SLM pixels. This allows us to settle in on patterns that are good for calibration and use the same calpoints_file for any SLM.

###### calPS
Sets the gaussian point-spread used during registration of the SLM with the camera.

###### calthresh
Threshold for binary mask applied to the camera snap image during SLM registration with the camera. Units are standard deviations of the snapped image. Assuming normally distributed noise with a limited number of spots, 10 standard deviations should be plenty.

## Methods

###### obj=SLM_Device(basepath)
This is the constructor method. It is called to generate new SLM_Device objects. Functionally, it reads in parameters from the stored textfiles and launches the Meadowlark_SDK. Note that parameters are read in using the "readcell" function with ':' as the delimiter. This has two distinct advantages. First, the parameter files are easily human-readable and can be modified with arbitrary whitespace. The ':' simply separates the name of the parameter from the value, which can be a scalar, an array, or a string. Second, the cell array allows for logical indexing, so the ordering of the parameters in the file doesn't matter. The params("params(:,1)=='name',2) extracts the value of the parameter (which is always stored to the right of the ':') that corresponds to the line where 'name' appears in the first column.

###### [obj,holo]=SLM_genholo(obj,Target,options)

This is the base method for generating holograms from a given target. The only required inputs are the SLM_Device object (obj) and a Target image (Target) which will usually be generated by the GenROI method. Additional options can be modified using a namae value pair. (e.g. SLM_genholo(obj,Target,'Blaze',[1 1]) would override the blaze stored with the device object and impose a blaze of [1 1] for the hologram.) Default values for all options are specified in the arguments block. Instead of automatically writing to the SLM, the user has the option to store the hologram as a frame in the Hologram_Stack by setting the "append_to_stack" option to 1. By default, the stack is cleared when a new hologram is written. This ensures that for the "simple" standard use case of projecting a single image for an experiment,
the user is sheilded from needing to worry about iterating through
the stack. Setting "write_when_complete" to 1 or using the
"Display_Simple" method are probably the best ways to exploit the
controller for the simple use case.

###### obj=DisplyNextFrame(obj)
DisplayNextFrame will project the hologram at the Stack_Frame_Num
position in the hologram stack and advance the Stack_Frame_Num
value by 1.

###### obj=DisplyNextFrame(obj)
Display_Simple projects the first hologram in the stack to the SLM.
For many uses of the controller, the stack will only contain one
hollogram at a time and Display_Simple will be the main method of
projecting the hologram on the SLM.

###### obj=SLM_TCal(obj,Cam)
SLM_TCal calibrates the affine transformation that registers the camera
coordinates to equivalent SLM coordinates. Requires a "Camera_Device"
(Cam) as an input, which is a class we have yet to write. First, the
controller projects the control points using the SLM. Then, the camera
will snap an image and pass it to the controller in the array "testimage". Then, the Target in SLM array ("fixed") is registered with the snapped camera image using the Transform_Cal function. See regirstation_guide.md in docs for explanation of this function. The returned 2daffine transform object "tform_out" is passed to the SLM device object and saved to the tform file. Future versions will integrate some error handling to make sure that the user doesn't unintentionally overwrite a good registration file.

###### [obj,Target]=GenROI(obj,Cam)
GenROI allows the user to create ROI targets in SLM coordinates from images produced by either a camera or a confocal scan. See registration_guide.md for an overview of how the SLM to confocal scan registration works. The  "smoothing" option sets the width of the gaussian blur applied to the Target in SLM units. A finite blur greatly improves the stability of the hologram generator without seriously degrading the resolution. The "ROI_Type" option can be set to 'points', 'polyedge', or 'polyregion'. If ROI_Type type is set to 'points', then the user will be prompted to click on each position on the image where they would like to drop a spot. If ROI_Type is set to 'polyedge' the user creates an unfilled polygonal ROI. This could be useful for selectively stimulating the cell membrane. Finally, the 'polyregion' ROI_Type allows the user to generate filled ROIs. The "append" option allows the user to add the generated target onto the stored object target, which means you can create a target from mixed ROI types. The renormalization of the targets after the addition will be relevant if there is overlap between the generated target and the stored target.

###### Target=GenTargetFromSpots(spotcoords,Dimensions,Width)
Simple helper function that takes the (sometimes fractional) spotcoords and converts them into a mask using gaussian PSFs centered on the spot coordinates.

###### SLM_Project(holo)
Helper function that calls the Meadowlark SDK to project a hologram.

###### ClearSDK()
Helper function that should be called at the end of every program. Provides a clean clear of the SDK from CPU memory.
